name: Windows Single EXE (Static)

on:
  workflow_dispatch:
  push:
    paths:
      - 'reversi_sfml.cpp'
      - 'CMakeLists.txt'
      - 'resources.rc'
      - '.github/workflows/windows-single-exe.yml'
      - 'fonts/**'

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
        shell: cmd
      
      - name: Install SFML (static)
        shell: cmd
        run: |
          cd vcpkg
          .\vcpkg.exe install sfml:x64-windows-static

      - name: Configure (CMake + vcpkg static)
        shell: cmd
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_TOOLCHAIN_FILE=vcpkg\scripts\buildsystems\vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-static -DSTATIC_SINGLE_EXE=ON -DEMBED_FONT=ON -DCMAKE_BUILD_TYPE=Release
      - name: List build files (debug)
        run: dir build\ /b

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Collect exe
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Recurse -Path build -Filter reversi.exe | Select-Object -First 1
          if (-not $exe) { Write-Error "reversi.exe not found" }
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          Copy-Item $exe.FullName dist/reversi.exe
          Write-Host "Collected: $($exe.FullName)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: reversi-windows-single-exe
          path: dist/reversi.exe
